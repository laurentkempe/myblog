---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection("posts");
const sortedPosts = allPosts.sort((a, b) => 
  new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
);

// Group posts by year and month
const postsByYearAndMonth = sortedPosts.reduce((acc, post) => {
  const date = new Date(post.data.date);
  const year = date.getFullYear();
  const month = date.toLocaleString('en-US', { month: 'long' });
  
  if (!acc[year]) {
    acc[year] = {};
  }
  if (!acc[year][month]) {
    acc[year][month] = [];
  }
  
  acc[year][month].push(post);
  return acc;
}, {} as Record<number, Record<string, typeof sortedPosts>>);

// Sort years in descending order
const years = Object.keys(postsByYearAndMonth)
  .map(Number)
  .sort((a, b) => b - a);

// Month names in chronological order
const monthNames = [
  'January', 'February', 'March', 'April', 'May', 'June',
  'July', 'August', 'September', 'October', 'November', 'December'
];
---

<Layout title="Archives">
  <div class="max-w-4xl mx-auto px-4">
    <h1 class="text-3xl font-bold mb-8 text-gray-900 dark:text-white">All Archives</h1>
    
    {years.map((year) => (
      <div class="mb-12">
        <h2 class="text-2xl font-semibold mb-6 text-gray-800 dark:text-gray-200">{year}</h2>
        
        {monthNames
          .filter((month) => postsByYearAndMonth[year][month])
          .reverse()
          .map((month) => (
            <div class="mb-6 ml-4">
              <h3 class="text-xl font-medium mb-3 text-gray-700 dark:text-gray-300">{month}</h3>
              <ul class="space-y-2 ml-4 list-disc list-outside">
                {postsByYearAndMonth[year][month].map((post) => (
                  <li class="text-gray-800 dark:text-gray-300">
                    <a 
                      href={post.data.permalink}
                      class="hover:text-blue-600 dark:hover:text-blue-400"
                    >
                      {post.data.title} <span class="text-gray-400 dark:text-gray-500">{new Date(post.data.date).toLocaleDateString('en-US', { 
                        month: 'short',
                        day: '2-digit',
                        year: 'numeric'
                      })}</span>
                    </a>
                  </li>
                ))}
              </ul>
            </div>
          ))}
      </div>
    ))}
  </div>
</Layout>